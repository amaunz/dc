<!DOCTYPE html>
<html lang="en">
  <head>
    <title>dc.js - Invitro Sens Pred</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/invitro_sens_pred.css"/>
  </head>

  <body>

  <table border=0 align='center'>
    <tr>
      <td colspan=3 align='center'>
        <strong>Responses: In-vivo by In-vitro</strong>
        <a class="reset" href="javascript:tumorModelAndCompoundBubbleChart.filterAll();dc.redrawAll();">reset</a>
        <div id="tumor-model-and-compound-bubble-chart"></div>
      </td>
    </tr>
    <tr>
      <td align='center'>
        <strong>Histogram of Frequencies per Tumor Model and Compound</strong>
        <a class="reset" href="javascript:tumorModelAndCompoundHistChart.filterAll();dc.redrawAll();">reset</a>
        <div id="tumor-model-and-compound-hist-chart"></div>
      </td>
      <td align='center'>
        <strong>Cancer Types</strong>
        <a class="reset" href="javascript:cancerTypeRingChart.filterAll();dc.redrawAll();">reset</a>
        <div id="cancer-type-chart"></div>
      </td>
      <td align='center'>
        <strong>Compounds</strong>
        <a class="reset" href="javascript:compoundRingChart.filterAll();dc.redrawAll();">reset</a>
        <div id="compound-chart"></div>
      </td>
    </tr>
  </table>
  <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>

  <script type="text/javascript" src="../js/d3.js"></script>
  <script type="text/javascript" src="../js/crossfilter.js"></script>
  <script type="text/javascript" src="../js/dc.js"></script>
  <script type="text/javascript">

    strSep = function() {
      return '__AND__'
    }

    labeler = function(lab, sep) {
      if (sep==undefined) sep="\n"
      return(lab.split(strSep()).join(sep))
    }

    getCancerTypeNumber = function (cancerType) {
      if (cancerType == 'MAXF') return 0 
      if (cancerType == 'CXF')  return 1
    }

    getDimensions = function() {
      return {
        x: 'Invitro',
        y: 'Invivo',
      }
    }
  
    getDimensionName = function(which) {
      return getDimensions()[which]
    }

    getTumorModelAndCompoundSelector = function(d) {
      return d.tumorModel + strSep() + d.compound
    }

    getTumorModelAndCompoundAndCountSelector = function(d) {
      return d.tumorModel + strSep() + d.compound + strSep() + d.tumorModelAndCompoundCount
    }

    getTumorModelAndCompoundExtent = function(cancerData) {
      return d3.extent(cancerData, function(d){return d.tumorModelAndCompoundCount})
    }
 
    
    // add counts for specified cols
    addCountsForTumorModelAndCompound = function(data) {
      var facts = crossfilter(data)
      var tumorModelAndCompoundDim = facts.dimension(function(d) {return getTumorModelAndCompoundSelector(d)})
      var tumorModelAndCompoundHist = tumorModelAndCompoundDim.group().reduceCount()
      var counts = tumorModelAndCompoundHist.all()
      counts.forEach(function(count) {
        var modelCompoundAry = count.key.split(strSep())
        data.forEach(function(d,i){
          if (d.tumorModel == modelCompoundAry[0] && d.compound == modelCompoundAry[1]) 
            d.tumorModelAndCompoundCount = count.value
        })
      })
      return data
    }
 

    var cancerTypeRingChart              = dc.pieChart("#cancer-type-chart")
    var compoundRingChart                = dc.pieChart("#compound-chart")
    var tumorModelAndCompoundHistChart   = dc.barChart("#tumor-model-and-compound-hist-chart")
    var tumorModelAndCompoundBubbleChart = dc.bubbleChart("#tumor-model-and-compound-bubble-chart")

    // use static or load via d3.csv("cancerData.csv", function(error, cancerData) {/* do stuff */});
    //var cancerData = [
    //  // x           y           color               label                label     
    //  {x: 40,  y: 3,  cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
    //  {x: 38,  y: 4,  cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
    //  {x: 35,  y: 4,  cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Vemurafenib'    },
    //  {x: 41,  y: 3,  cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Cisplatin'      },
    //  {x: 38,  y: 4,  cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Vemurafenib'    },
    //  {x: 62,  y: 4,  cancerType: 'MAXF', tumorModel: 'MAXF2', compound: '5-Fluorouracil' },
    //  {x: 110, y: 8,  cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Vemurafenib'    },
    //  {x: 120, y: 10, cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
    //  {x: 110, y: 12, cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
    //  {x: 200, y: 11, cancerType: 'CXF',  tumorModel: 'CXF1',  compound: '5-Fluorouracil' },
    //];

    var cancerData = [
      {value: 40,  dim: 'x', cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
      {value: 38,  dim: 'x', cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
      {value: 35,  dim: 'x', cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Vemurafenib'    },
      {value: 41,  dim: 'x', cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Cisplatin'      },
      {value: 38,  dim: 'x', cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Vemurafenib'    },
      {value: 62,  dim: 'x', cancerType: 'MAXF', tumorModel: 'MAXF2', compound: '5-Fluorouracil' },
      {value: 110, dim: 'x', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Vemurafenib'    },
      {value: 120, dim: 'x', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
      {value: 110, dim: 'x', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
      {value: 200, dim: 'x', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: '5-Fluorouracil' },
      {value: 3,   dim: 'y', cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
      {value: 4,   dim: 'y', cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
      {value: 4,   dim: 'y', cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Vemurafenib'    },
      {value: 3,   dim: 'y', cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Cisplatin'      },
      {value: 4,   dim: 'y', cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Vemurafenib'    },
      {value: 4,   dim: 'y', cancerType: 'MAXF', tumorModel: 'MAXF2', compound: '5-Fluorouracil' },
      {value: 8,   dim: 'y', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Vemurafenib'    },
      {value: 10,  dim: 'y', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
      {value: 12,  dim: 'y', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
      {value: 11,  dim: 'y', cancerType: 'CXF',  tumorModel: 'CXF1',  compound: '5-Fluorouracil' },
    ];



    cancerData                         = addCountsForTumorModelAndCompound(cancerData)
    var cancerFacts                    = crossfilter(cancerData)

    // dimensions
    var cancerTypeDim                  = cancerFacts.dimension(function(d) {return d.cancerType})
    var compoundDim                    = cancerFacts.dimension(function(d) {return d.compound  })
    var tumorModelAndCompoundDim       = cancerFacts.dimension(function(d) {return getTumorModelAndCompoundSelector(d)})
    var tumorModelAndCompoundCountDim  = cancerFacts.dimension(function(d) {return d.tumorModelAndCompoundCount})

    // reduce-count
    var cancerTypeHist                 = cancerTypeDim                .group().reduceCount()
    var compoundHist                   = compoundDim                  .group().reduceCount()
    var tumorModelAndCompoundCountHist = tumorModelAndCompoundCountDim.group().reduceCount()

    // reduce-custom
    var tumorModelAndCompoundReduction = tumorModelAndCompoundDim.group().reduce(
      function (p,v) {
        ++p.count
        p.sumX       += v.x
        p.avgX        = p.sumX / p.count
        p.sumY       += v.y
        p.avgY        = p.sumY / p.count
        p.label       = v.tumorModel + strSep() + v.compound 
        p.cancerType  = v.cancerType
        return p
      },
      function (p,v) {
        --p.count
        p.sumX       -= v.x
        p.avgX        = p.sumX / p.count
        p.sumY       -= v.y
        p.avgY        = p.sumY / p.count
        return p
      },
      function () {
        return({count: 0, sumX: 0, avgX: 0, sumY: 0, avgY: 0, label: '',})
      }
    )

    var xlim = getTumorModelAndCompoundExtent(cancerData)
    xlim[1]+=.1 // needed for brushing atm

  tumorModelAndCompoundHistChart
        .centerBar(true) // not working
        .gap(0.1)        // not working
        .renderHorizontalGridLines(true)
        .width(200).height(200)
        .dimension(tumorModelAndCompoundCountDim)
        .group(tumorModelAndCompoundCountHist)
        .colors(d3.scale.linear().range(['#BBB','#DDD']))
        .valueAccessor(function(d) {return(d.value/d.key)})
        .x(d3.scale.linear().domain(xlim))

//    TODO:
//    tumorModelAndCompoundHistChart
//      .xAxis().tickFormat(function(v) {return Math.round(v)})
//        .tickSubdivide(0)
//        .ticks(2)
//    tumorModelAndCompoundHistChart
//      .yAxis().tickFormat(function(v) {return Math.round(v)})
//        .tickSubdivide(0)
//        .ticks(6)



    cancerTypeRingChart
        .width(200).height(200)
        .dimension(cancerTypeDim)
        .group(cancerTypeHist)
        .innerRadius(0)
        .colors(d3.scale.category10())
    
    compoundRingChart
        .width(200).height(200)
        .dimension(compoundDim)
        .group(compoundHist)
        .innerRadius(0)
        .colors(d3.scale.linear().range(['#BBB','#DDD']))

    tumorModelAndCompoundBubbleChart
        .width(640)
        .height(300)
        .mouseZoomable(true)
        .dimension(tumorModelAndCompoundDim)
        .group(tumorModelAndCompoundReduction)
        .colors(d3.scale.category10())
        .colorAccessor(function (p) {
          return getCancerTypeNumber(p.value.cancerType)
         })
        .keyAccessor(function (p) {
           return p.value.avgX
         })
        .valueAccessor(function (p) {
           return p.value.avgY
         })
        .radiusValueAccessor(function (p) {
           return p.value.count;
         })

        .y(d3.scale.linear().domain(d3.extent(cancerData, function(d){return d.y})))
        .elasticY(true)
        .yAxisPadding(5)

        .x(d3.scale.linear().domain(d3.extent(cancerData, function(d){return d.x})))
        .elasticX(true)
        .xAxisPadding(50)

        .r(d3.scale.linear().domain([0, 20]))

        .label(function (p) {
          return labeler(p.value.label, ', ')
         })
        .title(function (p) {
            return labeler(
             'Substance, Model: ' + labeler(p.value.label, ', ') + strSep() 
            + getDimensionName('x') + ': ' + p.value.avgX + ', '
            + getDimensionName('y') + ': ' + p.value.avgY  + strSep()
            + 'Count: ' + p.value.count
          )
         })

        .renderHorizontalGridLines(true) // (optional) render horizontal grid lines, :default=false
        .renderVerticalGridLines(true) // (optional) render vertical grid lines, :default=false
    
    dc.renderAll()


  </script>

</body>
</html>
