<!DOCTYPE html>
<html lang="en">
  <head>
    <title>dc.js - Invitro Sens Pred</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/invitro_sens_pred.css"/>
  </head>

  <body>

  <table border=0 align='center'>
    <tr>
      <td colspan=2 align='center'>
        <strong>Responses: In-vivo by In-vitro</strong>
        <a class="reset" href="javascript:tumorModelAndCompoundBubbleChart.filterAll();dc.redrawAll();">reset</a>
        <div id="tumor-model-and-compound-bubble-chart"></div>
      </td>
    </tr>
    <tr>
      <td align='center'>
        <strong>Cancer Types</strong>
        <a class="reset" href="javascript:cancerTypeRingChart.filterAll();dc.redrawAll();">reset</a>
        <div id="cancer-type-chart"></div>
      </td>
      <td align='center'>
        <strong>Compounds</strong>
        <a class="reset" href="javascript:compoundRingChart.filterAll();dc.redrawAll();">reset</a>
        <div id="compound-chart"></div>
      </td>
    </tr>
  </table>
  <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>

  <script type="text/javascript" src="../js/d3.js"></script>
  <script type="text/javascript" src="../js/crossfilter.js"></script>
  <script type="text/javascript" src="../js/dc.js"></script>
  <script type="text/javascript">

    strSep = function() {
      return '__AND__'
    }

    labeler = function(lab, sep) {
      if (sep==undefined) sep="\n"
      var foo=lab.split(strSep()).join(sep)
      return(foo)
    }

    getCancerTypeNumber = function (cancerType) {
      if (cancerType == 'MAXF') return 0 
      if (cancerType == 'CXF')  return 1
    }

    var cancerTypeRingChart              = dc.pieChart("#cancer-type-chart")
    var compoundRingChart                = dc.pieChart("#compound-chart")
    var tumorModelAndCompoundBubbleChart = dc.bubbleChart("#tumor-model-and-compound-bubble-chart")

    // use static or load via d3.csv("cancerData.csv", function(error, cancerData) {/* do stuff */});
    var cancerData = [
      // x           y           color               label                label     
      {invitro: 40,  invivo: 3,  cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
      {invitro: 38,  invivo: 4,  cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Cisplatin'      },
      {invitro: 35,  invivo: 4,  cancerType: 'MAXF', tumorModel: 'MAXF1', compound: 'Vemurafenib'    },
      {invitro: 41,  invivo: 3,  cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Cisplatin'      },
      {invitro: 38,  invivo: 4,  cancerType: 'MAXF', tumorModel: 'MAXF2', compound: 'Vemurafenib'    },
      {invitro: 62,  invivo: 4,  cancerType: 'MAXF', tumorModel: 'MAXF2', compound: '5-Fluorouracil' },
      {invitro: 110, invivo: 8,  cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Vemurafenib'    },
      {invitro: 120, invivo: 10, cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
      {invitro: 110, invivo: 12, cancerType: 'CXF',  tumorModel: 'CXF1',  compound: 'Cisplatin'      },
      {invitro: 200, invivo: 11, cancerType: 'CXF',  tumorModel: 'CXF1',  compound: '5-Fluorouracil' },
    ];

    // set crossfilter
    var cancerFacts = crossfilter(cancerData),
        cancerTypeDim = cancerFacts.dimension(function(d) {return d.cancerType}),
        compoundDim   = cancerFacts.dimension(function(d) {return d.compound  }),
        tumorModelAndCompoundDim  = cancerFacts.dimension(function(d) {return d.tumorModel + strSep + d.compound}),
        cancerTypeHist = cancerTypeDim.group().reduceCount(),
        compoundHist   = compoundDim.group().reduceCount(),
        tumorModelAndCompoundReduction = tumorModelAndCompoundDim.group().reduce(
            // add
            function (p,v) {
              ++p.count
              p.sumInvitro += v.invitro
              p.avgInvitro  = p.sumInvitro / p.count
              p.sumInvivo  += v.invivo
              p.avgInvivo   = p.sumInvivo / p.count
              p.label       = v.compound + strSep() + v.tumorModel
              p.cancerType  = v.cancerType
              return p
            },
            // remove
            function (p,v) {
              --p.count
              p.sumInvitro -= v.invitro
              p.avgInvitro  = p.sumInvitro / p.count
              p.sumInvivo  -= v.invivo
              p.avgInvivo   = p.sumInvivo / p.count
              return p
            },
            // init p
            function () {
              return({
                count: 0, 
                sumInvitro: 0, 
                avgInvitro: 0,
                sumInvivo: 0, 
                avgInvivo: 0,
                label: '',
              })
            })
        
    cancerTypeRingChart
        .width(200).height(200)
        .dimension(cancerTypeDim)
        .group(cancerTypeHist)
        .innerRadius(0)
        .colors(d3.scale.category10())
    
    compoundRingChart
        .width(200).height(200)
        .dimension(compoundDim)
        .group(compoundHist)
        .innerRadius(0)
        .colors(d3.scale.linear().range(['#BBB','#DDD']))
    
    tumorModelAndCompoundBubbleChart
        .width(640)
        .height(300)
        .mouseZoomable(true)
        .dimension(tumorModelAndCompoundDim)
        .group(tumorModelAndCompoundReduction)
        .colors(d3.scale.category10())
        .colorAccessor(function (p) {
          return getCancerTypeNumber(p.value.cancerType)
         })
        .keyAccessor(function (p) {
           return p.value.avgInvitro
         })
        .valueAccessor(function (p) {
           return p.value.avgInvivo
         })
        .radiusValueAccessor(function (p) {
           return p.value.count;
         })

        .y(d3.scale.linear().domain([d3.extent(cancerData, function(d){return d.invivo})]))
        .elasticY(true)
        .yAxisPadding(5)

        .x(d3.scale.linear().domain([d3.extent(cancerData, function(d){return d.invitro})]))
        .elasticX(true)
        .xAxisPadding(50)

        .r(d3.scale.linear().domain([0, 20]))

        .label(function (p) {
          return labeler(p.value.label, '/')
         })
        .title(function (p) {
          return labeler(p.value.label + strSep() 
            + p.value.avgInvitro + strSep() 
            + p.value.avgInvivo  + strSep()
            + p.value.count
          )
         })

        .renderHorizontalGridLines(true) // (optional) render horizontal grid lines, :default=false
        .renderVerticalGridLines(true) // (optional) render vertical grid lines, :default=false
    
    dc.renderAll()


  </script>

</body>
</html>
